<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Delhi AQI Strategy Sandbox - Final</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
    #ui {
      position: absolute; top: 20px; left: 20px; z-index: 10;
      background: rgba(15, 15, 25, 0.95); color: #fff;
      padding: 20px; border-radius: 12px; width: 320px;
      font-family: 'Segoe UI', sans-serif; border: 1px solid #444;
      backdrop-filter: blur(10px); max-height: 90vh; overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .aqi-card { text-align: center; padding: 15px; border-radius: 8px; background: rgba(255,255,255,0.05); margin-bottom: 20px; }
    #aqiNum { font-size: 58px; font-weight: 900; line-height: 1; }
    #aqiTag { font-size: 13px; font-weight: bold; text-transform: uppercase; margin-top: 5px; }
    
    .section { margin-bottom: 18px; }
    .label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; }
    input[type=range] { width: 100%; accent-color: #ff5722; cursor: pointer; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { 
      background: #222; border: 1px solid #444; color: #ccc; 
      padding: 8px; border-radius: 5px; font-size: 11px; 
      cursor: pointer; display: flex; align-items: center; gap: 5px;
    }
    .btn:has(input:checked) { border-color: #ff5722; color: #fff; background: rgba(255, 87, 34, 0.1); }
    .warning { font-size: 11px; color: #ff5722; border-top: 1px solid #333; padding-top: 10px; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="ui">
    <div class="aqi-card">
      <div id="aqiNum">300</div>
      <div id="aqiTag">Very Poor</div>
    </div>

    <div class="section">
      <label class="label">Wind Speed: <span id="windVal">10</span> km/h</label>
      <input type="range" id="wind" min="2" max="45" value="10">
    </div>

    <div class="section">
      <label class="label">Base Emissions Loading</label>
      <input type="range" id="emissions" min="100" max="2000" value="1000">
    </div>

    <div class="section">
      <label class="label">Policy & Physical Interventions</label>
      <div class="grid">
        <label class="btn"><input type="checkbox" id="oddEven"> Odd-Even</label>
        <label class="btn"><input type="checkbox" id="grap3"> GRAP-3</label>
        <label class="btn"><input type="checkbox" id="grap4"> GRAP-4</label>
        <label class="btn"><input type="checkbox" id="water"> Sprinklers</label>
        <label class="btn"><input type="checkbox" id="tower"> Smog Tower</label>
      </div>
    </div>

    <div class="warning">
      Visibility is calculated using Mie scattering logic. Severe levels will obscure ground terrain entirely.
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <script>
    // Access Token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3MzI3MGIyZS1jZDEwLTRiOTYtOTJjNS1mZTFlOGVkNDg4NzUiLCJpZCI6Mzg1NzcyLCJpYXQiOjE3Njk5NDc2NTJ9.fvUHQUlAGhWQE_8fClYm3sWd0pnmkD7bKYUjQfrA_5g';

    async function start() {
      const viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: await Cesium.createWorldTerrainAsync(),
        baseLayerPicker: false, infoBox: false, animation: false, timeline: false,
        requestRenderMode: true
      });

      const buildings = await Cesium.createOsmBuildingsAsync();
      viewer.scene.primitives.add(buildings);

      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(77.2167, 28.6315, 600),
        orientation: { pitch: Cesium.Math.toRadians(-22) }
      });

      viewer.scene.fog.enabled = true;
      viewer.scene.globe.showGroundAtmosphere = true;

      const updateSim = () => {
        const e = parseFloat(document.getElementById('emissions').value);
        const w = parseFloat(document.getElementById('wind').value);
        document.getElementById('windVal').innerText = w;

        // Policy Logic (Multipliers)
        let policyFactor = 1.0;
        if (document.getElementById('oddEven').checked) policyFactor *= 0.82; // -18% Cars
        if (document.getElementById('grap3').checked) policyFactor *= 0.75;  // -25% Construction
        if (document.getElementById('grap4').checked) policyFactor *= 0.65;  // -35% Total lockdown
        if (document.getElementById('water').checked) policyFactor *= 0.90;  // -10% Dust suppression
        if (document.getElementById('tower').checked) policyFactor *= 0.96;  // -4% Localized purifiers

        // AQI Box Model: Concentration = Emissions / Wind
        const aqi = Math.round((e * policyFactor) / (w * 0.22));
        
        // UI Updates
        const aqiEl = document.getElementById('aqiNum');
        const tagEl = document.getElementById('aqiTag');
        aqiEl.innerText = aqi;

        let colorHex = '#ffff00';
        if (aqi > 400) { colorHex = '#7e0023'; tagEl.innerText = 'Severe+'; }
        else if (aqi > 300) { colorHex = '#ff0000'; tagEl.innerText = 'Severe'; }
        else if (aqi > 200) { colorHex = '#ff9900'; tagEl.innerText = 'Very Poor'; }
        else { colorHex = '#ffff00'; tagEl.innerText = 'Moderate/Poor'; }
        
        aqiEl.style.color = colorHex;
        tagEl.style.color = colorHex;

        // EXTREME FOG RENDERING
        // Doubled density: (aqi / 1000) * 0.012 creates a thick "soup" at 400+ AQI
        const fogDensity = (aqi / 1000) * 0.012;
        viewer.scene.fog.density = fogDensity;
        viewer.scene.fog.visualDensityScalar = 1.0; // Max visual impact

        // Mie Scattering Color: Shifts to Deep Brown in Severe levels
        const smogColor = aqi > 300 ? '#4b3621' : '#c0b0a0';
        viewer.scene.fog.color = Cesium.Color.fromCssColorString(smogColor);
        viewer.scene.skyAtmosphere.hueShift = (aqi / 1200);

        // ROBUST BUILDING STYLE (Fixed Rendering Error)
        buildings.style = new Cesium.Cesium3DTileStyle({
          color: {
            conditions: [
              // Use Number() to guard against null/string heights
              ['${height} === undefined || ${height} === null', "color('white', 0.5)"],
              ['Number(${height}) > 40', `color('${smogColor}', 0.98)`], // Top of buildings hide in fog
              ['true', `color('white', 0.8)`]
            ]
          }
        });

        viewer.scene.requestRender();
      };

      // Listener for all inputs
      document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', updateSim);
      });

      updateSim();
    }
    start();
  </script>
</body>
</html>
