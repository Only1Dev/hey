<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Delhi AQI Replica - Final Fix</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
    #ui {
      position: absolute; top: 20px; left: 20px; z-index: 10;
      background: rgba(10, 10, 15, 0.95); color: #fff;
      padding: 20px; border-radius: 12px; width: 300px;
      font-family: 'Segoe UI', sans-serif; border: 1px solid #444;
      backdrop-filter: blur(10px);
    }
    .aqi-val { font-size: 44px; font-weight: 900; }
    #aqiStatus { font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 4px; margin-left: 10px; }
    input[type=range] { width: 100%; accent-color: #ff5722; cursor: pointer; }
    .label { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 15px; display: block; }
    .checkbox-group { margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; font-size: 13px; color: #ccc; }
  </style>
</head>
<body>

  <div id="ui">
    <div style="display:flex; align-items:center;">
      <span class="aqi-val" id="aqiNum">150</span>
      <span id="aqiStatus" style="background:#ffcc00; color:#000">MODERATE</span>
    </div>

    <label class="label">Simulate Pollution Sources</label>
    <input type="range" id="eS" min="100" max="1000" value="450">
    
    <label class="label">Wind Speed (Dispersion)</label>
    <input type="range" id="wS" min="2" max="40" value="12">

    <div class="checkbox-group">
      <label><input type="checkbox" id="ev"> 50% EV Transition (-25%)</label><br>
      <label><input type="checkbox" id="smog"> Anti-Smog Spraying (-15%)</label><br>
      <label><input type="checkbox" id="green"> Green Belt Expansion (-10%)</label>
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3MzI3MGIyZS1jZDEwLTRiOTYtOTJjNS1mZTFlOGVkNDg4NzUiLCJpZCI6Mzg1NzcyLCJpYXQiOjE3Njk5NDc2NTJ9.fvUHQUlAGhWQE_8fClYm3sWd0pnmkD7bKYUjQfrA_5g';

    async function start() {
      try {
        const viewer = new Cesium.Viewer('cesiumContainer', {
          terrainProvider: await Cesium.createWorldTerrainAsync(),
          baseLayerPicker: false, infoBox: false, animation: false, timeline: false
        });

        const buildings = await Cesium.createOsmBuildingsAsync();
        viewer.scene.primitives.add(buildings);

        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(77.2167, 28.6315, 900),
          orientation: { pitch: Cesium.Math.toRadians(-30) }
        });

        viewer.scene.fog.enabled = true;

        const update = () => {
          const e = parseFloat(document.getElementById('eS').value);
          const w = parseFloat(document.getElementById('wS').value);
          
          let red = 0;
          if (document.getElementById('ev').checked) red += 0.25;
          if (document.getElementById('smog').checked) red += 0.15;
          if (document.getElementById('green').checked) red += 0.10;

          const aqi = Math.round((e / (w * 0.4)) * (1 - red));
          document.getElementById('aqiNum').innerText = aqi;

          let colorStr, status, statusCol;
          if (aqi > 350) { colorStr = '#7e0023'; status = 'SEVERE'; statusCol = '#ffffff'; }
          else if (aqi > 200) { colorStr = '#ff0000'; status = 'POOR'; statusCol = '#ffffff'; }
          else { colorStr = '#ffcc00'; status = 'MODERATE'; statusCol = '#000000'; }

          const tag = document.getElementById('aqiStatus');
          tag.innerText = status;
          tag.style.background = colorStr;
          tag.style.color = statusCol;
          document.getElementById('aqiNum').style.color = colorStr;

          viewer.scene.fog.density = (aqi / 1000) * 0.0012;
          viewer.scene.fog.color = Cesium.Color.fromCssColorString(aqi > 300 ? '#4b3621' : '#c0b0a0');

          // THE FIX: Explicitly cast ${height} to Number and check for undefined
          buildings.style = new Cesium.Cesium3DTileStyle({
            color: {
              conditions: [
                ['${height} === undefined || ${height} === null', "color('white', 0.5)"],
                ['Number(${height}) > 40', `color('${colorStr}', 0.8)`],
                ['Number(${height}) > 20', `color('${colorStr}', 0.6)`],
                ['true', "color('white', 0.5)"]
              ]
            }
          });
        };

        document.querySelectorAll('input').forEach(i => i.onchange = update);
        document.querySelectorAll('input[type=range]').forEach(i => i.oninput = update);
        update();

      } catch (err) { console.error("Sim Error:", err); }
    }
    start();
  </script>
</body>
</html>
